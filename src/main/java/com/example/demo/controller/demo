package com.example.demo.entity;

import java.time.LocalDateTime;
import java.util.List;

import jakarta.persistence.*;
import jakarta.validation.constraints.Email;
import jakarta.validation.constraints.NotBlank;
import jakarta.validation.constraints.NotNull;

@Entity
@Table(name = "student_profiles")
public class StudentProfile {




    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @NotBlank(message = "StudentId cannot be blank")
    @Column(unique = true, nullable = false)
    private String studentId;

    @NotBlank(message = "Name cannot be blank")
    private String name;

    @Email(message = "Invalid email format")
    @Column(unique = true)
    private String email;

    private String program;

    @NotNull(message = "Year level cannot be null")
    private Integer yearLevel;

    private Boolean repeatOffender = false;

    private LocalDateTime createdAt;

    @OneToMany(mappedBy = "studentProfile", cascade = CascadeType.ALL)
    private List<IntegrityCase> integrityCases;

    public StudentProfile() {}

    @PrePersist
    public void prePersist() {
        this.createdAt = LocalDateTime.now();
        this.repeatOffender = false;
    }

    // Getters and Setters
    public Long getId() { return id; }
    public String getStudentId() { return studentId; }
    public void setStudentId(String studentId) { this.studentId = studentId; }
    public String getName() { return name; }
    public void setName(String name) { this.name = name; }
    public String getEmail() { return email; }
    public void setEmail(String email) { this.email = email; }
    public String getProgram() { return program; }
    public void setProgram(String program) { this.program = program; }
    public Integer getYearLevel() { return yearLevel; }
    public void setYearLevel(Integer yearLevel) { this.yearLevel = yearLevel; }
    public Boolean getRepeatOffender() { return repeatOffender; }
    public void setRepeatOffender(Boolean repeatOffender) { this.repeatOffender = repeatOffender; }
    public LocalDateTime getCreatedAt() { return createdAt; }
} 





package com.example.demo.repository;

import java.util.Optional;

import org.springframework.data.jpa.repository.JpaRepository;
import com.example.demo.entity.StudentProfile;

public interface StudentProfileRepository extends JpaRepository<StudentProfile, Long> {

    Optional<StudentProfile> findByStudentId(String studentId);

}



// package com.example.demo.service;

// import java.util.List;
// import com.example.demo.entity.StudentProfile;

// public interface StudentProfileService {

//     StudentProfile createStudent(StudentProfile studentProfile);

//     StudentProfile getStudentById(Long id);

//     List<StudentProfile> getAllStudents();

//     StudentProfile updateRepeatOffenderStatus(Long studentId);

//     StudentProfile getStudentByStudentIdentifier(String studentIdentifier); 
// }  



package com.example.demo.service.impl;

import com.example.demo.entity.*;
import com.example.demo.exception.ResourceNotFoundException;
import com.example.demo.repository.*;
import com.example.demo.util.RepeatOffenderCalculator;
import java.util.List;

public class StudentProfileServiceImpl implements StudentProfileService {

    private final StudentProfileRepository repo;
    private final IntegrityCaseRepository caseRepo;
    private final RepeatOffenderRecordRepository recordRepo;
    private final RepeatOffenderCalculator calc;

    public StudentProfileServiceImpl(StudentProfileRepository repo,
                                     IntegrityCaseRepository caseRepo,
                                     RepeatOffenderRecordRepository recordRepo,
                                     RepeatOffenderCalculator calc) {
        this.repo = repo;
        this.caseRepo = caseRepo;
        this.recordRepo = recordRepo;
        this.calc = calc;
    }

    public StudentProfile createStudent(StudentProfile s) {
        s.setRepeatOffender(false);
        return repo.save(s);
    }

    public StudentProfile getStudentById(Long id) {
        return repo.findById(id).orElseThrow(() -> new ResourceNotFoundException("Student not found"));
    }

    public List<StudentProfile> getAllStudents() {
        return repo.findAll();
    }

    public StudentProfile updateRepeatOffenderStatus(Long id) {
        StudentProfile s = getStudentById(id);
        List<IntegrityCase> cases = caseRepo.findByStudentProfile(s);

        RepeatOffenderRecord record = calc.computeRepeatOffenderRecord(s, cases);
        recordRepo.save(record);

        s.setRepeatOffender(record.getTotalCases() >= 2);
        return repo.save(s);
    }
}




package com.example.demo.controller;

import java.util.List;

import jakarta.validation.Valid;

import org.springframework.web.bind.annotation.*;

import com.example.demo.entity.StudentProfile;
import com.example.demo.service.StudentProfileService;

@RestController
@RequestMapping("/students")
public class StudentProfileController {

    private final StudentProfileService service;

    public StudentProfileController(StudentProfileService service) {
        this.service = service;
    }

    // 1️⃣ create student
    @PostMapping
    public StudentProfile createStudent(@Valid @RequestBody StudentProfile student) {
        return service.createStudent(student);
    }

    // 2️⃣ get by id
    @GetMapping("/{id}")
    public StudentProfile getStudentById(@PathVariable Long id) {
        return service.getStudentById(id);
    }

    // 3️⃣ get all students
    @GetMapping
    public List<StudentProfile> getAllStudents() {
        return service.getAllStudents();
    }

    // 4️⃣ update repeat offender status
    @PutMapping("/{id}/repeat-status")
    public StudentProfile updateRepeatStatus(@PathVariable Long id) {
        return service.updateRepeatOffenderStatus(id);
    }

    // 5️⃣ get by studentIdentifier
    @GetMapping("/identifier/{studentIdentifier}")
    public StudentProfile getByStudentIdentifier(
            @PathVariable String studentIdentifier) {
        return service.getStudentByStudentIdentifier(studentIdentifier);
    }
} 